<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<meta name="theme-color" content="#000000"/>
<title>Mis Ventas â€” PWA</title>
<link rel="manifest" href="manifest.webmanifest">
<style>
:root{
  --bg:#eef0f4; --surface:#ffffff; --text:#0b1220; --muted:#687182;
  --border:#E5E7EB; --soft:#f3f4f6; --radius:16px; --shadow:0 6px 22px rgba(2,6,23,.06);
  --btn:#000000; --btnText:#ffffff; --btnBorder:#000000;
  --green:#10a37f; --red:#e11d48; --blue:#007BFF;
  --tabRing:#111827; /* LIGHT: dark gray */
}
[data-theme="dark"]{
  --bg:#0b1220; --surface:#0f172a; --text:#eef0f4; --muted:#B7C1D1;
  --border:#1f2937; --soft:#111827; --shadow:0 6px 22px rgba(0,0,0,.5);
  --btn:var(--blue); --btnText:#ffffff; --btnBorder:var(--blue);
  --tabRing:#FFFFFF; /* DARK: white */
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial,sans-serif;color:var(--text)}
header{position:sticky;top:0;z-index:50;background:var(--surface);border-bottom:1px solid var(--border)}
.wrap{max-width:980px;margin:0 auto;padding:30px 16px 30px}
.header-row{display:flex;align-items:center;gap:12px;justify-content:space-between}
.logo-title{font-size:42px;font-weight:900;letter-spacing:.2px}
.right-actions{display:flex;gap:10px;align-items:center}
.circle{width:40px;height:40px;border-radius:999px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;background:var(--soft);color:var(--text);font-weight:900;cursor:pointer}
[data-theme="dark"] .circle{ border-color:#ffffff; } 
nav{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:20px}
.btn,.tab{appearance:none;border:2px solid var(--btnBorder);background:var(--btn);color:var(--btnText);padding:12px 16px;border-radius:999px;font-weight:900;text-align:center;font-size:16px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:.15s}
.tab.active{ box-shadow: 0 0 0 2px var(--tabRing); } /* ring always visible */
.tab:focus-visible{ outline:none; box-shadow: 0 0 0 2px var(--tabRing); }
.container{max-width:980px;margin:0 auto;padding:12px 16px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;font-weight:800}
.title-sm{font-weight:800}
input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--surface);font-size:16px;color:var(--text)}
input[type="datetime-local"]{appearance:none;-webkit-appearance:none;padding:14px 16px;border-radius:14px;text-align:center;font-weight:600;letter-spacing:.3px}
.list{display:flex;flex-direction:column;gap:10px}
.list-item{position:relative; display:flex;align-items:flex-start;justify-content:space-between;padding:14px;border:1px solid var(--border);border-radius:14px;background:var(--surface);box-shadow:var(--shadow);overflow:hidden}
.muted{color:var(--muted)}.right{text-align:right}.hidden{display:none !important}
.picker{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:12px;background:var(--surface);padding:12px;cursor:pointer}

/* --- Carro: strict alignment, no overflow --- */
.cart-row{display:grid;grid-template-columns: minmax(0,1fr) 150px 120px;gap:8px;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
.cart-row .name{min-width:0;word-break:break-word}
.qty{display:flex;align-items:center;gap:10px;justify-content:center;text-align:center;font-variant-numeric: tabular-nums}
.qty strong{min-width:24px;text-align:center;display:inline-block}
.qty button{border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:999px;width:36px;height:36px;font-size:20px;line-height:1;cursor:pointer}
.price{font-variant-numeric: tabular-nums; text-align:right; display:block; min-width:0}
@media (max-width: 380px){
  .cart-row{grid-template-columns:minmax(0,1fr) 130px 110px}
}
/* --- End Carro --- */

.sheet{position:fixed;left:0;right:0;bottom:0;background:var(--surface);border-top-left-radius:16px;border-top-right-radius:16px;max-height:70vh;transform:translateY(100%);transition:.25s;box-shadow:0 -12px 30px rgba(0,0,0,.2);border:1px solid var(--border);touch-action:none}
.sheet.open{transform:translateY(0)}
.sheet .handle{width:50px;height:6px;background:#e5e7eb;border-radius:999px;margin:10px auto;cursor:pointer}
.sheet .body{padding:8px 14px 16px;overflow:auto;max-height:60vh}
.sheet .item{display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid var(--border);border-radius:12px;margin-bottom:8px}
.sheet .footer{display:none}

.row-actions{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}

.settings-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
.settings-actions{display:flex;gap:12px;align-items:center;justify-content:flex-end}
.btn--small{padding:10px 14px}
.icon-btn{display:inline-flex;align-items:center;justify-content:center;width:110px;height:40px}
.icon-share{width:22px;height:22px;display:inline-block}
.center{text-align:center}
#successOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);backdrop-filter:blur(2px);z-index:100}
#successCard{background:var(--surface);border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);padding:24px 32px;display:flex;flex-direction:column;align-items:center;gap:10px}
#successCard .check{width:64px;height:64px;border-radius:999px;background:#10a37f;display:flex;align-items:center;justify-content:center;color:#fff;font-size:38px;font-weight:900}

</style>
</head>
<body>
<header id="appHeader" class="hidden">
  <div class="wrap">
    <div class="header-row">
      <div class="logo-title">Mis Ventas</div>
      <div class="right-actions">
        <div class="circle" id="avatarCircle" title="Cuenta / Ajustes" onclick="showView('ajustes')"><span id="avatarText">?</span></div>
      </div>
    </div>
    <nav>
      <button class="tab active" id="tab-vender" onclick="showView('vender')">Vender</button>
      <button class="tab" id="tab-historial" onclick="showView('historial')">Historial</button>
      <button class="tab" id="tab-productos" onclick="showView('productos')">Productos</button>
    </nav>
  </div>
</header>

<main class="container">
  <!-- AUTH -->
  <section id="view-auth" class="card" style="max-width:420px;margin:28px auto">
    <h2 style="margin:6px 0 10px;">Bienvenido(a)</h2>
    <p class="muted" style="margin-top:0">Inicia sesiÃ³n con tu RUT y PIN de 6 dÃ­gitos o crea una cuenta.</p>
    <div id="loginForm">
      <label>RUT</label><input id="login-rut" placeholder="12345678-9">
      <label style="margin-top:8px;">PIN (6 dÃ­gitos)</label><input id="login-pin" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="6">
      <div style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:10px">
        <button class="btn" onclick="doLogin()">Entrar</button>
        <button class="btn" onclick="switchAuth()">Registrarse</button>
      </div>
      <p id="login-hint" class="muted" style="font-size:12px;margin-top:8px;"></p>
    </div>

    <div id="registerForm" class="hidden">
      <label>Nombre y Apellido</label><input id="reg-name" placeholder="Ej: CÃ©sar DÃ­az">
      <label style="margin-top:8px;">RUT</label><input id="reg-rut" placeholder="12345678-9">
      <label style="margin-top:8px;">PIN (6 dÃ­gitos)</label><input id="reg-pin" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="6">
      <div style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:10px">
        <button class="btn" onclick="doRegister()">Crear cuenta</button>
        <button class="btn" onclick="switchAuth()">Ya tengo cuenta</button>
      </div>
      <p id="reg-hint" class="muted" style="font-size:12px;margin-top:8px;"></p>
    </div>
  </section>

  <!-- Vender -->
  <section id="view-vender" class="hidden">
    <div class="card"><label>Nombre del Cliente</label><input id="cliente" placeholder="Ej: CÃ©sar DÃ­az"></div>
    <div class="card"><label>Fecha y hora</label><input id="fechaHora" type="datetime-local"></div>
    <div class="card"><label>Seleccionar el producto</label><div class="picker" onclick="openPicker()"><span id="pickerLabel">Elegir producto</span><span class="muted">â–¼</span></div></div>
    <div class="card">
      <div class="title-sm" style="margin-bottom:8px;">Carro</div>
      <div id="carro" class="cart"><span class="muted">Sin productos aÃºn.</span></div>
    </div>
    <div class="card">
      <div class="title-sm" style="margin-bottom:8px;">Resumen</div>
      <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Subtotal:</span><strong id="neto">$0</strong></div>
      <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>IVA (<span id="iva-rate">19</span>%)</span><strong id="iva">$0</strong></div>
      <div style="display:flex;justify-content:space-between;margin:6px 0;"><span>Total:</span><strong id="total">$0</strong></div>
    </div>
    <div class="card">
      <div class="row-actions">
        <button id="btnCompartir" class="btn btn--small" style="background:var(--green);border-color:var(--green)">Compartir y Guardar</button>
        <button id="btnLimpiar" class="btn btn--small" style="background:var(--red);border-color:var(--red)">Limpiar</button>
      </div>
    </div>
  </section>

  <!-- Historial -->
  <section id="view-historial" class="hidden">
    <div class="card"><label>Buscar por NÂ° o cliente</label><input id="buscar" placeholder="Ej: 0123 o CÃ©sar" oninput="aplicarFiltro()"></div>
    <div id="historial" class="list"></div>
  </section>

  <!-- Productos -->
  <section id="view-productos" class="hidden">
    <div class="card"><div class="title-sm" style="margin-bottom:8px;">Nuevo producto</div>
      <label>Nombre</label><input id="prod-nombre" placeholder="Nombre">
      <label style="margin-top:8px;">Precio</label><input id="prod-precio" type="number" min="0" placeholder="Precio">
      <div style="margin-top:10px"><button class="btn" onclick="agregarProducto()">Agregar</button></div>
    </div>
    <div class="card"><div class="title-sm" style="margin-bottom:8px;">CatÃ¡logo</div><div id="catalogo" class="list"></div></div>
  </section>

  <!-- Ajustes -->
  <section id="view-ajustes" class="hidden">
    <div class="card settings-row">
      <div class="title-sm">Tema</div>
      <div class="settings-actions">
        <button id="btn-light" class="btn btn--small" style="min-width:150px" onclick="setThemeSel('light')" aria-pressed="false">â˜€ Claro</button>
        <button id="btn-dark" class="btn btn--small" style="min-width:150px" onclick="setThemeSel('dark')" aria-pressed="false">ðŸŒ™ Oscuro</button>
      </div>
    </div>
    <div class="card settings-row">
      <div class="title-sm">IVA</div>
      <div class="settings-actions">
        <input id="iva-input" type="number" min="0" max="100" value="19" style="width:100px;margin-right:8px">
        <button class="btn btn--small" style="min-width:150px" onclick="guardarIVA()">Guardar IVA</button>
      </div>
    </div>
    <div class="card settings-row">
      <div class="title-sm">Respaldo</div>
      <div class="settings-actions" style="flex-wrap:wrap">
        <button class="btn btn--small" style="min-width:170px" onclick="exportarDatos()">Exportar historial</button>
        <input id="import-file" type="file" accept="application/json" class="hidden" onchange="importarDatos(this.files[0])"/>
        <button class="btn btn--small" style="min-width:170px" onclick="document.getElementById('import-file').click()">Importar historial</button>
      </div>
    </div>
    <div class="card"><div class="center"><button class="btn" style="background:var(--red);border-color:var(--red);min-width:220px" onclick="logout()">Cerrar sesiÃ³n</button></div></div>
  </section>
</main>

<div id="backdrop" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(1px)"></div>
<div class="sheet" id="sheet"><div class="handle" title="Cerrar"></div><div class="body" id="sheetBody"></div></div>

<!-- Success overlay (solo desde Vender) -->
<div id="successOverlay"><div id="successCard"><div class="check">âœ“</div><div style="font-weight:800">Venta realizada</div></div></div>

<script>
const $ = id => document.getElementById(id);
const fmt = new Intl.NumberFormat('es-CL',{ style:'currency', currency:'CLP', maximumFractionDigits:0 });
function applyTheme(){ const t=localStorage.getItem('theme')||'light'; document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light'); }
function setTheme(t){ localStorage.setItem('theme', t); applyTheme(); }
function markThemeButtons(t){ ['btn-light','btn-dark'].forEach(id=>{const el=$(id); if(!el) return; el.style.filter='none'; el.setAttribute('aria-pressed','false');}); const sel = t==='dark'?'btn-dark':'btn-light'; if($(sel)){ $(sel).style.filter='brightness(0.92)'; $(sel).setAttribute('aria-pressed','true'); } }
function setThemeSel(t){ setTheme(t); markThemeButtons(t); }
applyTheme(); markThemeButtons(localStorage.getItem('theme')||'light');

function attachPinMask(id){ const el=$(id); if(!el) return; el.addEventListener('input', ()=>{ el.value=(el.value||'').replace(/\\D/g,'').slice(0,6); }); }
function formatRutHyphenOnly(raw){ let r=(raw||'').toUpperCase().replace(/[^0-9K]/g,''); if(r.length<=1)return r; return r.slice(0,-1)+'-'+r.slice(-1); }
function attachRutMask(id){ const el=$(id); if(!el) return; el.addEventListener('input', ()=>{ const c=(el.value||'').toUpperCase().replace(/[^0-9K]/g,''); el.value=formatRutHyphenOnly(c); }); }

const company = { nombre:"MERCADITO QUILICURA SPA", giro:"VENTA DE TODO TIPO DE ALIMENTOS", direccion:"AV. LAS TORRES SUR 191 A", comuna:"Quilicura", ciudad:"Santiago", region:"Metropolitana de Santiago", rut:"77.934.268-9" };

function users(){ try{return JSON.parse(localStorage.getItem('users_rutpin'))||[]}catch{return[]} }
function saveUsers(arr){ localStorage.setItem('users_rutpin', JSON.stringify(arr)); }
function setSession(u){ localStorage.setItem('session', JSON.stringify(u)); }
function getSession(){ try{return JSON.parse(localStorage.getItem('session'))}catch{return null} }
function switchAuth(){ $('loginForm').classList.toggle('hidden'); $('registerForm').classList.toggle('hidden'); }

function doRegister(){
  const name=$('reg-name').value.trim();
  const rutMasked=$('reg-rut').value;
  let pin=($('reg-pin').value||'').replace(/\\D/g,''); 
  if(!name||!rutMasked||pin.length!==6){ alert('Completa nombre, RUT y un PIN de 6 dÃ­gitos.'); return; }
  const rut=(rutMasked||'').toUpperCase().replace(/[^0-9K]/g,'');
  const u=users(); if(u.some(x=>x.rut===rut)){ alert('Ese RUT ya estÃ¡ registrado.'); return; }
  u.push({rut, pin, name}); saveUsers(u); setSession({rut, name}); bootApp();
}
function doLogin(){
  const rutMasked=$('login-rut').value;
  const pin=($('login-pin').value||'').replace(/\\D/g,''); 
  const rut=(rutMasked||'').toUpperCase().replace(/[^0-9K]/g,'');
  const u=users().find(x=>x.rut===rut && x.pin===pin);
  if(!u){ $('login-hint').textContent='RUT o PIN invÃ¡lidos. Revisa que el PIN tenga 6 dÃ­gitos.'; alert('No se pudo iniciar sesiÃ³n'); return; }
  setSession({rut:u.rut, name:u.name}); bootApp();
}
function logout(){ localStorage.removeItem('session'); ['vender','historial','productos','ajustes'].forEach(x=>$('view-'+x).classList.add('hidden')); $('appHeader').classList.add('hidden'); $('view-auth').classList.remove('hidden'); $('login-pin').value=''; $('login-rut').value=''; }
attachRutMask('login-rut'); attachRutMask('reg-rut'); attachPinMask('login-pin'); attachPinMask('reg-pin');

function nsKey(k){ const s=getSession(); const uid=s?.rut||'anon'; return 'RUT:'+uid+':'+k; }
const store={ get(k,def){ try{return JSON.parse(localStorage.getItem(nsKey(k)))??def}catch{return def} }, set(k,v){ localStorage.setItem(nsKey(k), JSON.stringify(v)); } };

const defaults={ iva:19, productos:[
  {id:crypto.randomUUID(), nombre:'Aceite 1L', precio:3800},
  {id:crypto.randomUUID(), nombre:'Arroz 1kg', precio:1500},
  {id:crypto.randomUUID(), nombre:'AzÃºcar 1kg', precio:1200},
  {id:crypto.randomUUID(), nombre:'Fideos 400g', precio:900},
  {id:crypto.randomUUID(), nombre:'Leche 1L', precio:1100},
], ventas:[], nextCorrelativo:0 };

let carro=[];

function bootApp(){
  for(const [k,v] of Object.entries(defaults)){ if(store.get(k)==null) store.set(k,v); }
  $('iva-rate').textContent=store.get('iva',19); $('iva-input').value=store.get('iva',19);
  const now = new Date(); const tz = now.getTimezoneOffset()*60000; const localISO = new Date(now - tz).toISOString().slice(0,16);
  $('fechaHora').value = localISO;
  renderCatalogo(); renderPickerList(); renderCarro(); renderHistorial();
  const s=getSession(); const initials=s?.name?.split(' ').map(x=>x[0]?.toUpperCase()).slice(0,2).join('')||'?'; $('avatarText').textContent=initials;
  $('appHeader').classList.remove('hidden'); $('view-auth').classList.add('hidden'); showView('vender');
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }
  $('btnCompartir').onclick = compartirYGuardar;
  $('btnLimpiar').onclick = limpiar;
  const sheet=$('sheet'); // swipe-down to close
  let startY=null;
  sheet.addEventListener('touchstart',e=>{ startY=e.touches[0].clientY; }, {passive:true});
  sheet.addEventListener('touchmove',e=>{
    if(startY==null) return;
    const dy=e.touches[0].clientY-startY;
    if(dy>0){ sheet.style.transform=`translateY(${Math.min(100,dy)}px)`; }
  }, {passive:true});
  sheet.addEventListener('touchend',e=>{
    const current = parseFloat((sheet.style.transform||'translateY(0px)').match(/-?\\d+/)?.[0]||'0');
    if(current>60){ closePicker(); }
    sheet.style.transform='';
    startY=null;
  });
  $('backdrop').onclick = closePicker;
}

function showView(v){
  ['vender','historial','productos','ajustes'].forEach(x=>{
    const view=$('view-'+x); if(view) view.classList.toggle('hidden', x!==v);
    const tab=$('tab-'+x); if(tab) tab.classList.toggle('active', x===v);
  });
  if(v==='historial') renderHistorial();
  if(v==='productos') renderCatalogo();
}

// Picker
function openPicker(){ $('sheet').classList.add('open'); $('backdrop').classList.remove('hidden'); }
function closePicker(){ $('sheet').classList.remove('open'); $('backdrop').classList.add('hidden'); }
function renderPickerList(){
  const cont=$('sheetBody'); cont.innerHTML='';
  const productos=store.get('productos',[]).sort((a,b)=>a.nombre.localeCompare(b.nombre));
  for(const p of productos){
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`<div><div class='title-sm'>${p.nombre}</div><div class='muted'>${fmt.format(p.precio)}</div></div><button class='btn' style="background:#10a37f;border-color:#10a37f" onclick="addFromPicker('${p.id}')">Agregar</button>`;
    cont.appendChild(row);
  }
}
function addFromPicker(id){ agregarAlCarro(id); }

// Carro
function agregarAlCarro(id){
  const prod=store.get('productos',[]).find(x=>x.id===id); if(!prod) return;
  const ex=carro.find(x=>x.idProd===id); if(ex) ex.qty+=1; else carro.push({idProd:id,nombre:prod.nombre,precio:prod.precio,qty:1}); renderCarro();
}
function renderCarro(){
  const cont=$('carro'); if(carro.length===0){ cont.innerHTML='<span class="muted">Sin productos aÃºn.</span>'; updateTotals(); return; }
  cont.innerHTML=''; for(const it of carro){
    const row=document.createElement('div'); row.className='cart-row';
    row.innerHTML=`<div class='name'><div class='title-sm'>${it.nombre}</div></div>
                   <div class='qty'><button onclick="decQty('${it.idProd}')">âˆ’</button><strong>${it.qty}</strong><button onclick="incQty('${it.idProd}')">+</button></div>
                   <div class='right'><strong class="price">${fmt.format(it.precio*it.qty)}</strong></div>`;
    cont.appendChild(row);
  } updateTotals();
}
function incQty(id){ const it=carro.find(x=>x.idProd===id); if(!it) return; it.qty++; renderCarro(); }
function decQty(id){ const it=carro.find(x=>x.idProd===id); if(!it) return; it.qty--; if(it.qty<=0) carro=carro.filter(x=>x.idProd!==id); renderCarro(); }
function calcTotals(){ const ivaRate=store.get('iva',19); const neto=carro.reduce((s,i)=>s+i.precio*i.qty,0); const iva=Math.round(neto*ivaRate/100); const total=neto+iva; return {neto,iva,total,ivaRate}; }
function updateTotals(){ const t=calcTotals(); $('neto').textContent=fmt.format(t.neto); $('iva').textContent=fmt.format(t.iva); $('total').textContent=fmt.format(t.total); }

// Recibo (imagen para compartir) â€” con cabecera corregida y columnas alineadas
function drawReceiptToCanvas(v){
  const W=1120, H= Math.max(780, 420 + v.items.length*42);
  const canvas = document.createElement('canvas'); canvas.width=W; canvas.height=H;
  const ctx = canvas.getContext('2d');
  const bg = '#ffffff'; const fg = '#0b1220'; const green = '#13A37E'; const grid = '#cfe9df';
  const money = n => new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}).format(n);
  ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);
  let x=70, y=120;
  ctx.fillStyle=fg; ctx.font='bold 22px Arial'; ctx.textAlign='left'; ctx.fillText("MERCADITO QUILICURA SPA", x, y); y+=28;
  ctx.font='16px Arial'; ctx.fillText('Giro: VENTA DE TODO TIPO DE ALIMENTOS', x, y); y+=22;
  ctx.fillText('DirecciÃ³n: AV. LAS TORRES SUR 191 A', x, y); y+=22;
  ctx.fillText('Comuna: Quilicura', x, y); y+=22;
  ctx.fillText('Ciudad: Santiago', x, y); y+=22;
  ctx.fillText('RegiÃ³n: Metropolitana de Santiago', x, y);
  const boxX = W-380, boxY=90, boxW=300, boxH=140;
  ctx.strokeStyle='#e74c3c'; ctx.lineWidth=3; ctx.strokeRect(boxX, boxY, boxW, boxH);
  ctx.fillStyle=fg; ctx.textAlign='center';
  ctx.font='16px Arial'; ctx.fillText('R.U.T.: 77.934.268-9', boxX+boxW/2, boxY+28);
  ctx.font='bold 18px Arial'; ctx.fillText('NÂ° DE PEDIDO', boxX+boxW/2, boxY+58);
  ctx.font='bold 22px Arial'; ctx.fillText(String(v.correlativo).padStart(4,'0'), boxX+boxW/2, boxY+92);
  // Fecha + Hora
  const parts = (v.fecha||'').split(' ');
  const fStr = parts[0] || v.fecha;
  const hStr = parts[1] || '';
  ctx.textAlign='left'; ctx.fillStyle=fg; ctx.font='14px Arial';
  ctx.fillText('Fecha de EmisiÃ³n', boxX, boxY+160);
  ctx.font='bold 14px Arial'; ctx.fillText(fStr, boxX+160, boxY+160);
  ctx.font='14px Arial'; ctx.fillText('Hora de transacciÃ³n', boxX, boxY+182);
  ctx.font='bold 14px Arial'; ctx.fillText(hStr, boxX+160, boxY+182);

  // Tabla
  const thY = boxY+210;
  ctx.fillStyle=green; ctx.fillRect(50, thY, W-100, 28);
  ctx.fillStyle='#ffffff'; ctx.font='bold 14px Arial'; ctx.fillText('DETALLE DEL DOCUMENTO', 60, thY+19);
  const rowStart = thY+40;
  ctx.fillStyle=grid; ctx.fillRect(50, rowStart, W-100, 28);
  ctx.fillStyle=fg; ctx.font='bold 13px Arial'; ctx.textAlign='left';
  ctx.fillText('Nombre', 60, rowStart+18);
  ctx.fillText('Cantidad', 520, rowStart+18);
  ctx.fillText('P. Unitario', 660, rowStart+18);
  ctx.textAlign='right'; ctx.fillText('Subtotal', 1040, rowStart+18); // header alineado
  let iy=rowStart+40;
  ctx.font='13px Arial'; ctx.fillStyle=fg; ctx.textAlign='left';
  for(const it of v.items){
    ctx.fillStyle= (Math.round((iy-rowStart)/28)%2===0) ? '#f8fbfa' : '#ffffff';
    ctx.fillRect(50, iy-14, W-100, 28);
    ctx.fillStyle=fg;
    const name = it.nombre.length>55 ? it.nombre.slice(0,55)+'â€¦' : it.nombre;
    ctx.fillText(name, 60, iy);
    ctx.fillText(String(it.cantidad), 520, iy);
    ctx.fillText(money(it.precio), 660, iy);
    const sub = money(it.precio*it.cantidad);
    ctx.textAlign='right'; ctx.fillText(sub, 1040, iy); ctx.textAlign='left';
    iy+=28;
  }
  const sumY = iy + 20, sumX = W-380, sumW = 300, sumH = 110;
  ctx.strokeStyle=green; ctx.lineWidth=2; ctx.strokeRect(sumX, sumY, sumW, sumH);
  ctx.font='13px Arial'; ctx.fillStyle=fg;
  const labelX = sumX + 20; const amountX = sumX + sumW - 20;
  ctx.textAlign='left'; ctx.fillText('Neto:', labelX, sumY+32);
  ctx.textAlign='right'; ctx.fillText(money(v.neto), amountX, sumY+32);
  ctx.textAlign='left'; ctx.fillText('IVA ('+v.ivaRate+'%):', labelX, sumY+56);
  ctx.textAlign='right'; ctx.fillText(money(v.iva), amountX, sumY+56);
  ctx.font='bold 15px Arial';
  ctx.textAlign='left'; ctx.fillText('Total:', labelX, sumY+80);
  ctx.textAlign='right'; ctx.fillText(money(v.total), amountX, sumY+80);
  ctx.textAlign='left';
  return canvas;
}
async function shareReceiptImage(v){
  const canvas = drawReceiptToCanvas(v);
  const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.92));
  const file = new File([blob], `Pedido_${String(v.correlativo).padStart(4,'0')}.jpg`, {type:'image/jpeg'});
  if(navigator.canShare && navigator.canShare({files:[file]})){
    try{ await navigator.share({files:[file], title:'Pedido', text:`Pedido NÂ° ${String(v.correlativo).padStart(4,'0')}`}); }catch(e){}
  } else {
    const url=URL.createObjectURL(file); const a=document.createElement('a'); a.href=url; a.download=file.name; a.click(); URL.revokeObjectURL(url);
  }
}

function showSuccess(){
  const o=$('successOverlay'); o.style.display='flex';
  setTimeout(()=>{ o.style.display='none'; }, 1100);
}

async function compartirYGuardar(){
  if(carro.length===0){ alert('Agrega productos al carro.'); return; }
  const nombre=($('cliente').value||'').trim();
  if(!nombre){ alert('Ingresa el nombre del cliente.'); return; } // obligatorio
  const ventas=store.get('ventas',[]);
  const next=store.get('nextCorrelativo',0);
  const correlativo=next+1;
  const t=calcTotals();
  const fechaUI = $('fechaHora').value || new Date().toISOString().slice(0,16).replace('T',' ');
  const v={ correlativo, fecha:fechaUI.replace('T',' '), cliente:nombre, items:carro.map(i=>({nombre:i.nombre,precio:i.precio,cantidad:i.qty})), neto:t.neto, iva:t.iva, total:t.total, ivaRate:t.ivaRate };
  ventas.push(v); store.set('ventas',ventas); store.set('nextCorrelativo',correlativo);
  await shareReceiptImage(v);
  showSuccess();
  limpiar(); renderHistorial();
}
function limpiar(){ carro=[]; $('cliente').value=''; const now=new Date(); const tz=now.getTimezoneOffset()*60000; $('fechaHora').value=new Date(now - tz).toISOString().slice(0,16); updateTotals(); renderCarro(); }

// Historial (compacto + icono compartir)
function ventaCardHTML(v){
  const corr = String(v.correlativo).padStart(4,'0');
  return `
    <div style="flex:1 1 auto; min-width:0; position:relative; z-index:1;">
      <div class="title-sm">Pedido NÂ° ${corr} â€” ${v.fecha}</div>
      <div class="muted">Cliente: ${v.cliente} Â· Total: ${fmt.format(v.total)}</div>
      <div id="exp-${v.correlativo}" class="hidden" style="margin-top:8px;">
        ${renderVentaDetalleHTML(v)}
      </div>
    </div>
    <div style="flex:0 0 110px; display:flex; justify-content:flex-end; align-items:flex-start; z-index:1;">
      <button class="btn btn--small" style="width:110px; background:#10a37f;border-color:#10a37f" onclick="toggleVer(${v.correlativo})">Ver</button>
    </div>`;
}
function renderVentaDetalleHTML(v){
  const items=v.items.map(i=>`<div style="display:flex;justify-content:space-between; gap:10px; font-variant-numeric:tabular-nums">
      <span style="min-width:0; flex:1 1 auto; overflow:hidden; text-overflow:ellipsis">${i.nombre} Â· ${i.cantidad} x ${fmt.format(i.precio)}</span>
      <strong style="text-align:right; min-width:100px">${fmt.format(i.precio*i.cantidad)}</strong>
    </div>`).join('');
  return `<div>
    <div class="muted">Cliente: ${v.cliente}</div>
    ${items}
    <hr/>
    <div style="display:flex;justify-content:space-between;"><span>Neto</span><strong>${fmt.format(v.neto)}</strong></div>
    <div style="display:flex;justify-content:space-between;"><span>IVA (${v.ivaRate}%)</span><strong>${fmt.format(v.iva)}</strong></div>
    <div style="display:flex;justify-content:space-between;"><span>Total</span><strong>${fmt.format(v.total)}</strong></div>
    <div style="display:flex; justify-content:flex-end; margin-top:8px;">
      <button class="btn icon-btn" onclick="compartirDesdeHist(${v.correlativo})" title="Compartir" aria-label="Compartir">
        <svg class="icon-share" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <circle cx="5" cy="12" r="3"></circle>
          <circle cx="19" cy="5" r="3"></circle>
          <circle cx="19" cy="19" r="3"></circle>
          <path d="M7.7 10.7l7.6-4.4M7.7 13.3l7.6 4.4" stroke="currentColor" stroke-width="2" fill="none"></path>
        </svg>
      </button>
    </div>
  </div>`;
}
function getVentas(){ return store.get('ventas',[]).sort((a,b)=>b.correlativo-a.correlativo); }
function renderHistorial(){
  const cont=$('historial'); cont.innerHTML='';
  for(const v of getVentas()){
    const div=document.createElement('div'); div.className='list-item'; div.innerHTML = ventaCardHTML(v); cont.appendChild(div);
  }
}
function aplicarFiltro(){
  const q = ($('buscar').value||'').trim().toLowerCase();
  const cont=$('historial'); cont.innerHTML='';
  const ventas = getVentas().filter(v=>{
    const cor = String(v.correlativo).padStart(4,'0').includes(q);
    const nom = (v.cliente||'').toLowerCase().includes(q);
    return q==='' || cor || nom;
  });
  for(const v of ventas){
    const div=document.createElement('div'); div.className='list-item'; div.innerHTML = ventaCardHTML(v); cont.appendChild(div);
  }
}
function toggleVer(c){ const el=$('exp-'+c); if(el) el.classList.toggle('hidden'); }
async function compartirDesdeHist(c){
  const ventas=store.get('ventas',[]); const v=ventas.find(x=>x.correlativo===c); if(!v) return;
  await shareReceiptImage(v);
}

// Exportar/Importar (Respaldo) por RUT
function exportarDatos(){
  const s = getSession();
  if(!s || !s.rut){ alert('Inicia sesiÃ³n para exportar.'); return; }
  const prefix = 'RUT:'+s.rut+':';
  const dump = {};
  for (let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if (k && k.startsWith(prefix)) dump[k] = localStorage.getItem(k);
  }
  const blob = new Blob([JSON.stringify(dump, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `backup_${s.rut}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}
function importarDatos(file){
  if (!file){ return; }
  const s = getSession();
  if(!s || !s.rut){ alert('Inicia sesiÃ³n para importar.'); return; }
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      const prefix = 'RUT:'+s.rut+':';
      let count = 0;
      Object.entries(data).forEach(([k,v]) => {
        if (k.startsWith(prefix)){ localStorage.setItem(k,v); count++; }
      });
      alert('Importado correctamente ('+count+' claves). Recarga el Historial si no lo ves.');
      renderHistorial();
    }catch(e){
      alert('Archivo invÃ¡lido');
    }
  };
  reader.readAsText(file);
}

(function(){ const s=getSession(); if(s){ bootApp(); } else { $('view-auth').classList.remove('hidden'); } })();
</script>
</body>
</html>
